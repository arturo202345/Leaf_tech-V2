{% extends "clasificador/encabezado.html" %}
{% load static %}
{% block content %}
    <link rel="stylesheet" href="{% static 'css/detalle.css' %}">
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <link rel="stylesheet" href="{% static 'css/modal.css' %}">
    

<div class="detalle-container">
    <!-- Encabezado -->
    <div class="detalle-header">
        <a href="{% url 'mis_plantas' %}" class="btn-back">‚Üê Volver a Mi Colecci√≥n</a>
        <h1>{{ planta.especie.nombre }} #{{ planta.id }}</h1>
        <!-- CAMBIADO: ahora redirige a la p√°gina de confirmar eliminaci√≥n -->
        <a href="{% url 'eliminar_planta' planta.id %}" class="btn-delete">
            üóëÔ∏è Eliminar
        </a>
    </div>

    <!-- Informaci√≥n principal -->
    <div class="info-grid">
        <!-- Imagen y estado -->
        <div class="card card-imagen">
            <div class="planta-imagen-grande">
                {% if planta.especie.imagen_url %}
                    <img src="{{ planta.especie.imagen_url }}" alt="{{ planta.especie.nombre }}">
                {% else %}
                    <img src="https://images.unsplash.com/photo-1614594975525-e45190c55d0b?w=400&h=500&fit=crop" alt="{{ planta.especie.nombre }}">
                {% endif %}
            </div>
            <div class="estado-badge {% if planta.estado == 1 %}saludable{% elif planta.estado == 0 %}atencion{% else %}critica{% endif %}">
                <span class="estado-icono">
                    {% if planta.estado == 1 %}‚úì{% elif planta.estado == 0 %}‚ö†{% else %}‚ö†Ô∏è{% endif %}
                </span>
                <span>
                    {% if planta.estado == 1 %}
                        Saludable
                    {% elif planta.estado == 0 %}
                        Enferma
                    {% else %}
                        Cr√≠tica
                    {% endif %}
                </span>
            </div>
        </div>

        <!-- An√°lisis de color actual -->
        <div class="card card-datos-actuales">
            <h2>üé® An√°lisis de Color Actual</h2>
            
            <div class="color-bars">
                <div class="color-bar-item">
                    <div class="color-bar-header">
                        <span class="color-indicator verde"></span>
                        <span class="color-label">Verde</span>
                        <span class="color-value">{{ planta.porcentaje_verde|floatformat:1 }}%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill verde" style="width: {{ planta.porcentaje_verde }}%"></div>
                    </div>
                </div>

                <div class="color-bar-item">
                    <div class="color-bar-header">
                        <span class="color-indicator amarillo"></span>
                        <span class="color-label">Amarillo</span>
                        <span class="color-value">{{ planta.porcentaje_amarillo|floatformat:1 }}%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill amarillo" style="width: {{ planta.porcentaje_amarillo }}%"></div>
                    </div>
                </div>

                <div class="color-bar-item">
                    <div class="color-bar-header">
                        <span class="color-indicator marron"></span>
                        <span class="color-label">Marr√≥n</span>
                        <span class="color-value">{{ planta.porcentaje_marron|floatformat:1 }}%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill marron" style="width: {{ planta.porcentaje_marron }}%"></div>
                    </div>
                </div>

                <div class="color-bar-item">
                    <div class="color-bar-header">
                        <span class="color-indicator rojo"></span>
                        <span class="color-label">Rojo</span>
                        <span class="color-value">{{ planta.porcentaje_rojo|floatformat:1 }}%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill rojo" style="width: {{ planta.porcentaje_rojo }}%"></div>
                    </div>
                </div>
            </div>

            {% if planta.descripcion_estado %}
            <div class="estado-descripcion">
                <strong>Diagn√≥stico:</strong>
                <p>{{ planta.descripcion_estado }}</p>
            </div>
            {% endif %}
            
            <p class="ultima-actualizacion">
                üìÖ √öltima actualizaci√≥n: {{ planta.ultima_actualizacion|date:"d/m/Y H:i" }}
            </p>
        </div>

        <!-- Informaci√≥n taxon√≥mica -->
        <div class="card card-taxonomia">
            <h2>üî¨ Informaci√≥n Taxon√≥mica</h2>
            
            <div class="info-item">
                <strong>Nombre com√∫n:</strong>
                <p>{{ planta.especie.nombre }}</p>
            </div>
            
            {% if planta.especie.nombre_cientifico %}
            <div class="info-item">
                <strong>Nombre cient√≠fico:</strong>
                <p><em>{{ planta.especie.nombre_cientifico }}</em></p>
            </div>
            {% endif %}
            
            {% if planta.especie.familia %}
            <div class="info-item">
                <strong>Familia:</strong>
                <p>{{ planta.especie.familia }}</p>
            </div>
            {% endif %}
            
            <div class="info-item">
                <strong>Total de monitoreos:</strong>
                <p>{{ total_monitoreos }}</p>
            </div>

            <div class="info-item">
                <strong>Fecha de registro:</strong>
                <p>{{ planta.fecha_agregada|date:"d/m/Y H:i" }}</p>
            </div>
        </div>

        <!-- Informaci√≥n adicional de la especie -->
        <div class="card card-info-adicional">
            <h2>üìñ Sobre esta Especie</h2>
            
            {% if planta.especie.descripcion %}
            <div class="info-item">
                <p>{{ planta.especie.descripcion }}</p>
            </div>
            {% else %}
            <p class="no-datos">No hay descripci√≥n disponible para esta especie.</p>
            {% endif %}
            
            {% if planta.especie.referencia_url %}
            <div class="info-item">
                <a href="{{ planta.especie.referencia_url }}" target="_blank" class="btn-referencia">
                    üîó Ver m√°s informaci√≥n
                </a>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Historial de monitoreos -->
    <div class="card card-historial">
        <div class="historial-header">
            <h2>üìä Historial de Monitoreos</h2>
        </div>
        
        {% if monitoreos %}
        <div class="tabla-container">
            <table class="tabla-monitoreos">
                <thead>
                    <tr>
                        <th>Fecha y Hora</th>
                        <th>üü¢ Verde</th>
                        <th>üü° Amarillo</th>
                        <th>üü§ Marr√≥n</th>
                        <th>üî¥ Rojo</th>
                        <th>Estado</th>
                        <th>Diagn√≥stico</th>
                        <th>Notas</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for monitoreo in monitoreos %}
                    <tr>
                        <td>{{ monitoreo.fecha_monitoreo|date:"d/m/Y H:i" }}</td>
                        <td>{{ monitoreo.porcentaje_verde|floatformat:1 }}%</td>
                        <td>{{ monitoreo.porcentaje_amarillo|floatformat:1 }}%</td>
                        <td>{{ monitoreo.porcentaje_marron|floatformat:1 }}%</td>
                        <td>{{ monitoreo.porcentaje_rojo|floatformat:1 }}%</td>
                        <td>
                            <span class="badge-estado {% if monitoreo.estado == 1 %}badge-saludable{% elif monitoreo.estado == 0 %}badge-enferma{% else %}badge-critica{% endif %}">
                                {% if monitoreo.estado == 1 %}
                                    ‚úì Saludable
                                {% elif monitoreo.estado == 0 %}
                                    ‚ö† Enferma
                                {% else %}
                                    ‚ö†Ô∏è Cr√≠tica
                                {% endif %}
                            </span>
                        </td>
                        <td>{{ monitoreo.descripcion_estado|default:"-" }}</td>
                        <td>
                            <div class="notas-cell">
                                {% if monitoreo.notas %}
                                    <span class="nota-preview">{{ monitoreo.notas|truncatewords:10 }}</span>
                                {% else %}
                                    <span class="sin-notas">Sin notas</span>
                                {% endif %}
                            </div>
                        </td>
                        <td>
                            <button class="btn-nota" onclick="abrirModalNotas({{ monitoreo.id }}, '{{ monitoreo.notas|escapejs }}')">
                                {% if monitoreo.notas %}
                                    ‚úèÔ∏è Editar
                                {% else %}
                                    ‚ûï Agregar
                                {% endif %}
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        {% if total_monitoreos > 20 %}
        <p class="nota-historial">Mostrando los √∫ltimos 20 monitoreos de {{ total_monitoreos }} totales</p>
        {% endif %}
        
        {% else %}
        <p class="no-datos">No hay monitoreos registrados para esta planta a√∫n.</p>
        {% endif %}
    </div>
</div>

<!-- Modal para Notas -->
<div id="modalNotas" class="modal">
  <div class="modal-content modal-notas">
    <div class="modal-header">
      <h2>üé§ <span id="modalTitulo">Grabar Nota de Voz</span></h2>
      <span class="close" onclick="cerrarModalNotas()">&times;</span>
    </div>

    <div class="form-group">
      <p>Presiona para grabar tu nota de voz:</p>
      <button id="btnGrabar" class="btn-guardar">üéôÔ∏è Grabar</button>
      <button id="btnDetener" class="btn-cancelar" disabled>‚èπÔ∏è Detener</button>

      <div id="grabacionEstado" style="margin-top:10px;color:#444;"></div>
    </div>

    <div class="form-actions">
      <button type="button" class="btn-cancelar" onclick="cerrarModalNotas()">Cerrar</button>
    </div>
  </div>
</div>
    
<script src="{% static 'Js/detalle.js' %}"></script>

{% endblock content %}